# Implementation Plan: NapCat CQ Code Parser & Message Statistics

**Branch**: `002-napcat-cqcode-parser` | **Date**: 2026-02-11 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/002-napcat-cqcode-parser/spec.md`

**Note**: This plan was generated by the `/speckit.plan` command following the workflow in `.specify/templates/commands/plan.md`.

## Summary

Implement CQ code parsing and automatic message statistics for NapCat/OneBot 11 protocol. The system will:

1. **Parse CQ codes** from string-based messages (e.g., `[CQ:face,id=123]`) into structured data using regex-based parser with compiled pattern cache
2. **Calculate statistics** for every message: character count (Unicode code points) and CQ code counts by type (face, image, at, reply, record, video)
3. **Auto-reply** with formatted statistics (non-zero items only) within 2 seconds, filtering bot's own messages to prevent loops
4. **Frontend UI** for CQ code pattern selection using Element Plus Cascader with predefined templates
5. **Extended API integration** via WebSocket JSON-RPC with automatic HTTP fallback for additional NapCat endpoints

**Technical Approach** (from research.md):
- Regex parser with Caffeine cache (95%+ hit rate, <10ms P95 parsing)
- Java 17 `codePointCount()` for accurate mixed-script character counting (<1ms)
- Self-ID matching for bot message filtering (<0.1ms overhead)
- Reuse existing WebSocket connection for JSON-RPC API calls (20-50ms latency)
- Element Plus Cascader for user-friendly CQ code rule builder (<1 minute rule creation)

## Technical Context

**Language/Version**: Java 17 (LTS) with modern features (records, pattern matching, sealed classes)
**Primary Dependencies**:
- Spring Boot 3.1.8 (Jakarta EE 9+)
- MyBatis-Plus 3.5.7 (ORM + code generation)
- Caffeine 3.x (local cache for compiled regex patterns)
- Redis 7.x (distributed cache for rate limiting)
- Jackson 2.15 (JSON parsing for WebSocket JSON-RPC)
- Vue 3.4+ with TypeScript 5.x (frontend)
- Element Plus 2.x (UI components)

**Storage**:
- MySQL 8.0+ (persistent storage via existing schema)
- Redis 7.x (rate limiting counters, rule cache)
- Caffeine (in-memory cache for compiled patterns, statistics rules)

**Testing**:
- JUnit 5 + Mockito + AssertJ (unit tests)
- TestContainers (MySQL integration tests)
- Vitest + Vue Test Utils (frontend component tests)
- Playwright (E2E tests)

**Target Platform**:
- Backend: Linux/macOS server (JVM 17+)
- Frontend: Modern browsers (Chrome 90+, Firefox 88+, Safari 14+)
- Deployment: Docker containers (docker-compose for local, Kubernetes for production)

**Project Type**: Web application (backend + frontend)

**Performance Goals**:
- CQ code parsing: P95 <10ms, P99 <15ms
- Statistics calculation: P95 <50ms (total pipeline)
- API response time: P95 <200ms, P99 <500ms
- Statistics reply latency: <2 seconds end-to-end (budget breakdown: parsing <10ms + calculation <50ms + Redis rate limit check <5ms + NapCat send API <200ms + network latency <1.7s)
- Cache hit rate: â‰¥95% for compiled patterns
- Frontend initial load: <2s on 4G network

**Constraints**:
- Must reuse existing WebSocket connection (no new connections)
- Must maintain backward compatibility with existing message parsing logic
- Frontend bundle size: vendor <500KB, page chunks <200KB
- QQ message length limit: ~5000 characters for statistics reply
- Rate limiting: Max 1 statistics reply per 5 seconds per group (abuse prevention)

**Scale/Scope**:
- Expected message volume: 100-1000 messages/minute across all groups
- Concurrent groups: 10-50 active groups
- CQ code types supported: 6+ (face, image, at, reply, record, video, extensible)
- Frontend components: 5-8 new components (CQ code selector, statistics display)
- Backend classes: 10-15 new classes (parser, calculator, service, DTO/VO)
- Test coverage target: Backend â‰¥80%, Frontend â‰¥70%

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### âœ… Core Principles Compliance

**ä¸€ã€ä»£ç è´¨é‡æ ‡å‡†**:
- âœ… **JDK 17**: Using Java 17 features (records for CQCode, sealed classes for CQ code types if needed)
- âœ… **Spring Boot 3.x**: Framework version 3.1.8 (Jakarta EE 9+)
- âœ… **MyBatis-Plus**: Version 3.5.7 for ORM (existing infrastructure)
- âœ… **Code Quality**: SonarQube scan required, complexity limits enforced (methods â‰¤10, classes â‰¤50)
- âœ… **Javadoc**: All public methods documented (CQCodeParser, MessageStatisticsService)
- âœ… **é˜¿é‡Œå·´å·´è§„èŒƒ**: Following mandatory rules (no `SELECT *`, parameterized queries)
- âœ… **Frontend Vue 3**: Composition API with TypeScript, Element Plus components
- âœ… **ESLint**: No `any` types, strict type checking enabled

**äºŒã€æµ‹è¯•ä¼˜å…ˆåŸåˆ™ (TDD)**:
- âœ… **TDD Workflow**: Write tests â†’ User approval â†’ Red â†’ Green â†’ Refactor
- âœ… **Coverage Targets**: Backend â‰¥80%, Frontend â‰¥70%
- âœ… **Test Layers**:
  - Unit tests: `src/test/java/.../unit/` (CQCodeParserTest, MessageStatisticsServiceTest)
  - Integration tests: `src/test/java/.../integration/` (with TestContainers MySQL)
  - Frontend tests: `frontend/src/tests/unit/` (CQCodeSelector.spec.ts)
- âœ… **Test Naming**: `should_ReturnExpectedResult_When_GivenSpecificCondition()`

**ä¸‰ã€ç”¨æˆ·ä½“éªŒä¸€è‡´æ€§**:
- âœ… **API Response Format**: Unified `Result<T>` wrapper with code/message/data/timestamp
- âœ… **Error Handling**: Clear error codes, user-friendly messages
- âœ… **i18n**: Chinese labels for CQ code types (å›¾ç‰‡, è¡¨æƒ…, è¯­éŸ³, etc.)
- âœ… **Element Plus**: Reuse existing UI component library (Cascader, Form, Table)
- âœ… **Accessibility**: Form labels, ARIA attributes on interactive elements

**å››ã€æ€§èƒ½è¦æ±‚**:
- âœ… **API P95 <200ms**: Statistics calculation <50ms, total pipeline <200ms
- âœ… **Cache Strategy**: Caffeine (95%+ hit rate), Redis (rate limiting)
- âœ… **N+1 Query Prevention**: Batch operations, no iterative DB calls
- âœ… **Frontend Performance**: Route lazy loading, bundle size <500KB vendor
- âœ… **Slow Query Monitoring**: Log queries >100ms, optimize before production

**äº”ã€å¯è§‚æµ‹æ€§ä¸å®‰å…¨**:
- âœ… **Structured Logging**: SLF4J + Logback with clear levels (ERROR/WARN/INFO/DEBUG)
- âœ… **Sensitive Data**: No plain text passwords/tokens in logs
- âœ… **Metrics**: Expose `/actuator/prometheus` for monitoring
- âœ… **Health Check**: `/actuator/health` with dependency checks
- âœ… **Input Validation**: Jakarta Validation on all DTOs
- âœ… **Security**: SQL injection prevention (MyBatis `#{}`), XSS prevention (Vue auto-escape)
- âœ… **Rate Limiting**: Max 1 statistics reply per 5 seconds per group

### âœ… Technical Stack Compliance

**Mandatory Technologies**:
- âœ… Java 17 (not JDK 11 or lower)
- âœ… Spring Boot 3.1.8 (not 2.x)
- âœ… MyBatis-Plus 3.5.7 (not Spring Data JPA)
- âœ… MySQL 8.0+ (not PostgreSQL)
- âœ… Vue 3 Composition API (not Vue 2 or Options API)
- âœ… TypeScript (not JavaScript)
- âœ… Pinia (not Vuex)
- âœ… Vite (not Webpack)

**Prohibited Technologies**:
- â›” Spring Data JPA / Hibernate (using MyBatis-Plus)
- â›” Spring Boot 2.x (using 3.1.8)
- â›” javax.* packages (using jakarta.*)
- â›” Vue 2.x / Options API (using Vue 3 Composition API)
- â›” Vuex (using Pinia)

### ğŸ“‹ Constitution Gate Status: **PASSED**

All mandatory principles and technical constraints are satisfied. No violations requiring justification.

**Re-check After Phase 1**: Will verify data model design and API contracts maintain compliance.

## Project Structure

### Documentation (this feature)

```text
specs/002-napcat-cqcode-parser/
â”œâ”€â”€ spec.md              # Feature specification (completed)
â”œâ”€â”€ plan.md              # This file (implementation plan)
â”œâ”€â”€ research.md          # Phase 0 research report (completed)
â”œâ”€â”€ data-model.md        # Phase 1 data model design (to be generated)
â”œâ”€â”€ quickstart.md        # Phase 1 developer quickstart (to be generated)
â”œâ”€â”€ contracts/           # Phase 1 API contracts (to be generated)
â”‚   â”œâ”€â”€ cqcode-api.yaml  # CQ code parsing API contract
â”‚   â””â”€â”€ statistics-api.yaml  # Statistics calculation API contract
â””â”€â”€ tasks.md             # Phase 2 task breakdown (NOT created by /speckit.plan)
```

### Source Code (repository root)

**Structure Decision**: Web application (backend + frontend) following standard Maven project layout for backend and Vite project layout for frontend.

```text
# Backend (Standard Maven Project - src/ at project root)
src/
â”œâ”€â”€ main/
â”‚   â”œâ”€â”€ java/com/specqq/chatbot/
â”‚   â”‚   â”œâ”€â”€ parser/              # NEW: CQ code parsing
â”‚   â”‚   â”‚   â”œâ”€â”€ CQCodeParser.java
â”‚   â”‚   â”‚   â”œâ”€â”€ CQCode.java (record)
â”‚   â”‚   â”‚   â””â”€â”€ CQCodeType.java (enum)
â”‚   â”‚   â”œâ”€â”€ service/
â”‚   â”‚   â”‚   â”œâ”€â”€ MessageStatisticsService.java  # NEW: Statistics calculation
â”‚   â”‚   â”‚   â””â”€â”€ CQCodeService.java             # NEW: CQ code operations
â”‚   â”‚   â”œâ”€â”€ adapter/
â”‚   â”‚   â”‚   â””â”€â”€ NapCatAdapter.java       # MODIFY: Add WebSocket JSON-RPC support
â”‚   â”‚   â”œâ”€â”€ dto/
â”‚   â”‚   â”‚   â”œâ”€â”€ MessageStatisticsDTO.java      # NEW: Statistics data transfer
â”‚   â”‚   â”‚   â”œâ”€â”€ CQCodePatternDTO.java          # NEW: Frontend CQ code pattern
â”‚   â”‚   â”‚   â””â”€â”€ ApiCallRequestDTO.java         # NEW: WebSocket API call request
â”‚   â”‚   â”œâ”€â”€ vo/
â”‚   â”‚   â”‚   â””â”€â”€ MessageStatisticsVO.java       # NEW: Statistics view object
â”‚   â”‚   â”œâ”€â”€ controller/
â”‚   â”‚   â”‚   â””â”€â”€ CQCodeController.java          # NEW: CQ code API endpoints
â”‚   â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”‚   â””â”€â”€ CQCodeCacheConfig.java         # NEW: Caffeine cache for CQ patterns
â”‚   â”‚   â””â”€â”€ common/
â”‚   â”‚       â””â”€â”€ CQCodeConstants.java           # NEW: CQ code type constants
â”‚   â””â”€â”€ resources/
â”‚       â””â”€â”€ mapper/
â”‚           â””â”€â”€ (no new mappers - reuse existing tables)
â””â”€â”€ test/
    â””â”€â”€ java/com/specqq/chatbot/
        â”œâ”€â”€ unit/
        â”‚   â”œâ”€â”€ CQCodeParserTest.java          # NEW: Parser unit tests
        â”‚   â”œâ”€â”€ MessageStatisticsServiceTest.java  # NEW: Statistics tests
        â”‚   â””â”€â”€ CQCodeServiceTest.java         # NEW: Service layer tests
        â”œâ”€â”€ integration/
        â”‚   â”œâ”€â”€ CQCodeIntegrationTest.java     # NEW: End-to-end parsing tests
        â”‚   â””â”€â”€ StatisticsRuleIntegrationTest.java  # NEW: Rule engine tests
        â””â”€â”€ resources/
            â””â”€â”€ test-messages.json             # NEW: Test data (sample CQ messages)

# Frontend (Vite + Vue 3 + TypeScript)
frontend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â””â”€â”€ cqcode.ts                # NEW: CQ code API client
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ CQCodeSelector.vue       # NEW: CQ code pattern selector (Cascader)
â”‚   â”‚   â”œâ”€â”€ CQCodePreview.vue        # NEW: CQ code preview component
â”‚   â”‚   â””â”€â”€ MessageStatisticsDisplay.vue  # NEW: Statistics display widget
â”‚   â”œâ”€â”€ views/
â”‚   â”‚   â””â”€â”€ rules/
â”‚   â”‚       â””â”€â”€ RuleEdit.vue         # MODIFY: Add CQ code selector integration
â”‚   â”œâ”€â”€ stores/
â”‚   â”‚   â””â”€â”€ cqcode.ts                # NEW: Pinia store for CQ code patterns
â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â”œâ”€â”€ cqcode.ts                # NEW: TypeScript types for CQ codes
â”‚   â”‚   â””â”€â”€ statistics.ts            # NEW: TypeScript types for statistics
â”‚   â””â”€â”€ utils/
â”‚       â””â”€â”€ cqcode-formatter.ts      # NEW: CQ code display formatting
â””â”€â”€ tests/
    â””â”€â”€ unit/
        â”œâ”€â”€ CQCodeSelector.spec.ts   # NEW: Component unit tests
        â””â”€â”€ cqcode-formatter.spec.ts # NEW: Utility function tests

# Configuration
pom.xml                              # MODIFY: No new dependencies needed
frontend/package.json                # No changes (reuse Element Plus)
```

**Key Directories**:
- **NEW**: `src/main/java/.../parser/` - CQ code parsing logic
- **NEW**: `frontend/src/components/` - CQ code UI components
- **MODIFY**: `src/main/java/.../adapter/NapCatAdapter.java` - Add WebSocket JSON-RPC
- **REUSE**: Existing rule engine, message router, WebSocket handler

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| [e.g., 4th project] | [current need] | [why 3 projects insufficient] |
| [e.g., Repository pattern] | [specific problem] | [why direct DB access insufficient] |
