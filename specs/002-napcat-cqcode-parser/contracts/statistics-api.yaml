openapi: 3.0.3
info:
  title: Message Statistics API
  description: |
    API for calculating and formatting message statistics (character count and CQ code counts).

    **Feature**: `002-napcat-cqcode-parser`
    **Version**: 1.0.0
    **Base Path**: `/api/statistics`

    **Auto-Reply Behavior**: When statistics rule is enabled for a group, the system automatically:
    1. Parses every incoming message
    2. Calculates statistics (character count + CQ code counts by type)
    3. Sends formatted reply to the same group within 2 seconds
    4. Filters out bot's own messages to prevent infinite loops
  version: 1.0.0
  contact:
    name: SpecQQ Development Team

servers:
  - url: http://localhost:8080/api
    description: Development server
  - url: https://api.specqq.example.com/api
    description: Production server

tags:
  - name: Statistics Calculation
    description: Calculate message statistics
  - name: Statistics Formatting
    description: Format statistics for display
  - name: Statistics Rules
    description: Manage statistics rules for groups

paths:
  /statistics/calculate:
    post:
      tags:
        - Statistics Calculation
      summary: Calculate message statistics
      description: |
        Calculates character count and CQ code counts for a message.

        **Performance**: P95 <50ms (total pipeline)

        **Character Counting**:
        - Uses Unicode code points (not UTF-16 code units)
        - One Chinese character = 1, one English letter = 1
        - Excludes CQ codes from character count

        **CQ Code Counting**:
        - Groups by type (face, image, at, reply, record, video)
        - Returns only non-zero counts

        **Example**:
        - Input: `"你好世界[CQ:face,id=123][CQ:image,file=abc.jpg]"`
        - Output: `{"characterCount": 4, "cqCodeCounts": {"face": 1, "image": 1}}`
      operationId: calculateStatistics
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CalculateStatisticsRequest'
            examples:
              mixedContent:
                summary: Message with text and CQ codes
                value:
                  message: "你好世界[CQ:face,id=123][CQ:image,file=abc.jpg]"
              textOnly:
                summary: Pure text message
                value:
                  message: "Hello World"
              cqCodesOnly:
                summary: Only CQ codes
                value:
                  message: "[CQ:face,id=1][CQ:face,id=2][CQ:image,file=test.jpg]"
      responses:
        '200':
          description: Successfully calculated statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CalculateStatisticsResponse'
              examples:
                mixedContent:
                  value:
                    code: 200
                    message: "Success"
                    data:
                      characterCount: 4
                      cqCodeCounts:
                        face: 1
                        image: 1
                      totalCQCodeCount: 2
                      hasCQCodes: true
                    timestamp: "2026-02-11T10:30:00Z"
                textOnly:
                  value:
                    code: 200
                    message: "Success"
                    data:
                      characterCount: 11
                      cqCodeCounts: {}
                      totalCQCodeCount: 0
                      hasCQCodes: false
                    timestamp: "2026-02-11T10:30:00Z"
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /statistics/format:
    post:
      tags:
        - Statistics Formatting
      summary: Format statistics as reply message
      description: |
        Formats statistics into a human-readable Chinese message for group chat reply.

        **Format Rules**:
        - Only non-zero items are displayed
        - Character count: "文字: X字"
        - CQ code counts: "表情: X个, 图片: X张, 语音: X条" etc.
        - Items separated by ", " (comma + space)

        **Examples**:
        - All types: `"文字: 10字, 表情: 2个, 图片: 1张"`
        - Text only: `"文字: 15字"`
        - CQ codes only: `"表情: 3个, 图片: 2张"`
      operationId: formatStatistics
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FormatStatisticsRequest'
      responses:
        '200':
          description: Successfully formatted statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FormatStatisticsResponse'
              examples:
                allTypes:
                  value:
                    code: 200
                    message: "Success"
                    data:
                      formattedMessage: "文字: 10字, 表情: 2个, 图片: 1张"
                      characterCount: 4
                      cqCodeCounts:
                        face: 2
                        image: 1
                    timestamp: "2026-02-11T10:30:00Z"
                textOnly:
                  value:
                    code: 200
                    message: "Success"
                    data:
                      formattedMessage: "文字: 15字"
                      characterCount: 15
                      cqCodeCounts: {}
                    timestamp: "2026-02-11T10:30:00Z"
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /statistics/calculate-and-format:
    post:
      tags:
        - Statistics Calculation
      summary: Calculate and format statistics (combined operation)
      description: |
        Convenience endpoint that combines calculate + format operations.

        **Use Case**: Direct message-to-reply conversion

        **Performance**: P95 <50ms
      operationId: calculateAndFormat
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CalculateAndFormatRequest'
      responses:
        '200':
          description: Successfully calculated and formatted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FormatStatisticsResponse'
              examples:
                success:
                  value:
                    code: 200
                    message: "Success"
                    data:
                      formattedMessage: "文字: 7字, 表情: 1个, 图片: 1张"
                      characterCount: 7
                      cqCodeCounts:
                        face: 1
                        image: 1
                    timestamp: "2026-02-11T10:30:00Z"
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /statistics/rules:
    get:
      tags:
        - Statistics Rules
      summary: List statistics rules
      description: |
        Returns all message rules configured for statistics calculation.

        **Rule Type**: `match_type = 'statistics'`
      operationId: listStatisticsRules
      parameters:
        - name: groupId
          in: query
          description: Filter by group ID
          schema:
            type: integer
            format: int64
          example: 123456
        - name: enabled
          in: query
          description: Filter by enabled status
          schema:
            type: boolean
          example: true
        - name: page
          in: query
          description: Page number (1-indexed)
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: size
          in: query
          description: Page size
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
      responses:
        '200':
          description: List of statistics rules
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListStatisticsRulesResponse'
              examples:
                success:
                  value:
                    code: 200
                    message: "Success"
                    data:
                      total: 5
                      page: 1
                      size: 20
                      items:
                        - ruleId: 101
                          ruleName: "消息统计"
                          groupId: 123456
                          groupName: "测试群"
                          enabled: true
                          priority: 100
                          createdAt: "2026-02-10T08:00:00Z"
                          updatedAt: "2026-02-11T10:00:00Z"
                    timestamp: "2026-02-11T10:30:00Z"
        '500':
          $ref: '#/components/responses/InternalServerError'

  /statistics/rules/{ruleId}/toggle:
    put:
      tags:
        - Statistics Rules
      summary: Enable or disable statistics rule
      description: |
        Toggles the enabled status of a statistics rule for a specific group.

        **Effect**:
        - Enabled: Bot will auto-reply with statistics for every message
        - Disabled: Bot will not process statistics for messages in this group
      operationId: toggleStatisticsRule
      parameters:
        - name: ruleId
          in: path
          required: true
          description: Rule ID
          schema:
            type: integer
            format: int64
          example: 101
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ToggleRuleRequest'
      responses:
        '200':
          description: Successfully toggled rule
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ToggleRuleResponse'
              examples:
                enabled:
                  value:
                    code: 200
                    message: "Success"
                    data:
                      ruleId: 101
                      enabled: true
                      message: "Statistics rule enabled for group 123456"
                    timestamp: "2026-02-11T10:30:00Z"
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /statistics/test:
    post:
      tags:
        - Statistics Calculation
      summary: Test statistics calculation with preview
      description: |
        Test endpoint for validating statistics calculation logic.

        **Use Case**: Frontend rule testing, debugging

        **Returns**: Statistics + formatted message + execution time
      operationId: testStatistics
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TestStatisticsRequest'
      responses:
        '200':
          description: Test result with detailed breakdown
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TestStatisticsResponse'
              examples:
                success:
                  value:
                    code: 200
                    message: "Success"
                    data:
                      originalMessage: "Hello[CQ:face,id=123]世界[CQ:image,file=abc.jpg]"
                      strippedMessage: "Hello世界"
                      characterCount: 7
                      cqCodeCounts:
                        face: 1
                        image: 1
                      formattedMessage: "文字: 7字, 表情: 1个, 图片: 1张"
                      executionTimeMs: 8
                      cacheHit: true
                    timestamp: "2026-02-11T10:30:00Z"
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

components:
  schemas:
    # Request Schemas
    CalculateStatisticsRequest:
      type: object
      required:
        - message
      properties:
        message:
          type: string
          description: Message string to calculate statistics for
          example: "你好世界[CQ:face,id=123]"
          maxLength: 10000

    FormatStatisticsRequest:
      type: object
      required:
        - characterCount
        - cqCodeCounts
      properties:
        characterCount:
          type: integer
          description: Number of characters (excluding CQ codes)
          minimum: 0
          example: 10
        cqCodeCounts:
          type: object
          additionalProperties:
            type: integer
            minimum: 0
          description: Count per CQ code type
          example:
            face: 2
            image: 1

    CalculateAndFormatRequest:
      type: object
      required:
        - message
      properties:
        message:
          type: string
          description: Message string to process
          example: "Hello[CQ:face,id=123]World"
          maxLength: 10000

    ToggleRuleRequest:
      type: object
      required:
        - enabled
      properties:
        enabled:
          type: boolean
          description: Enable or disable the rule
          example: true

    TestStatisticsRequest:
      type: object
      required:
        - message
      properties:
        message:
          type: string
          description: Test message
          example: "Test[CQ:face,id=1]Message"
          maxLength: 10000
        includeDebugInfo:
          type: boolean
          description: Include debug information (cache hit, execution time)
          default: true

    # Response Schemas
    CalculateStatisticsResponse:
      allOf:
        - $ref: '#/components/schemas/BaseResponse'
        - type: object
          properties:
            data:
              $ref: '#/components/schemas/MessageStatistics'

    FormatStatisticsResponse:
      allOf:
        - $ref: '#/components/schemas/BaseResponse'
        - type: object
          properties:
            data:
              type: object
              required:
                - formattedMessage
                - characterCount
                - cqCodeCounts
              properties:
                formattedMessage:
                  type: string
                  description: Formatted statistics message (Chinese)
                  example: "文字: 10字, 表情: 2个, 图片: 1张"
                characterCount:
                  type: integer
                  description: Character count
                  example: 10
                cqCodeCounts:
                  type: object
                  additionalProperties:
                    type: integer
                  description: CQ code counts by type
                  example:
                    face: 2
                    image: 1

    ListStatisticsRulesResponse:
      allOf:
        - $ref: '#/components/schemas/BaseResponse'
        - type: object
          properties:
            data:
              type: object
              required:
                - total
                - page
                - size
                - items
              properties:
                total:
                  type: integer
                  description: Total number of rules
                  example: 5
                page:
                  type: integer
                  description: Current page (1-indexed)
                  example: 1
                size:
                  type: integer
                  description: Page size
                  example: 20
                items:
                  type: array
                  items:
                    $ref: '#/components/schemas/StatisticsRule'

    ToggleRuleResponse:
      allOf:
        - $ref: '#/components/schemas/BaseResponse'
        - type: object
          properties:
            data:
              type: object
              required:
                - ruleId
                - enabled
                - message
              properties:
                ruleId:
                  type: integer
                  format: int64
                  description: Rule ID
                  example: 101
                enabled:
                  type: boolean
                  description: New enabled status
                  example: true
                message:
                  type: string
                  description: Status message
                  example: "Statistics rule enabled for group 123456"

    TestStatisticsResponse:
      allOf:
        - $ref: '#/components/schemas/BaseResponse'
        - type: object
          properties:
            data:
              type: object
              required:
                - originalMessage
                - strippedMessage
                - characterCount
                - cqCodeCounts
                - formattedMessage
              properties:
                originalMessage:
                  type: string
                  description: Original input message
                strippedMessage:
                  type: string
                  description: Message with CQ codes removed
                characterCount:
                  type: integer
                  description: Character count
                cqCodeCounts:
                  type: object
                  additionalProperties:
                    type: integer
                  description: CQ code counts by type
                formattedMessage:
                  type: string
                  description: Formatted statistics message
                executionTimeMs:
                  type: integer
                  description: Execution time in milliseconds
                  example: 8
                cacheHit:
                  type: boolean
                  description: Whether cache was hit
                  example: true

    # Domain Models
    MessageStatistics:
      type: object
      required:
        - characterCount
        - cqCodeCounts
        - totalCQCodeCount
        - hasCQCodes
      properties:
        characterCount:
          type: integer
          description: Number of Unicode characters (excluding CQ codes)
          minimum: 0
          example: 10
        cqCodeCounts:
          type: object
          additionalProperties:
            type: integer
            minimum: 1
          description: Count per CQ code type (only non-zero counts)
          example:
            face: 2
            image: 1
        totalCQCodeCount:
          type: integer
          description: Total CQ code count across all types
          minimum: 0
          example: 3
        hasCQCodes:
          type: boolean
          description: Whether message contains any CQ codes
          example: true

    StatisticsRule:
      type: object
      required:
        - ruleId
        - ruleName
        - groupId
        - groupName
        - enabled
        - priority
      properties:
        ruleId:
          type: integer
          format: int64
          description: Rule ID
          example: 101
        ruleName:
          type: string
          description: Rule name
          example: "消息统计"
        groupId:
          type: integer
          format: int64
          description: QQ group ID
          example: 123456
        groupName:
          type: string
          description: Group name
          example: "测试群"
        enabled:
          type: boolean
          description: Whether rule is enabled
          example: true
        priority:
          type: integer
          description: Rule priority (higher = earlier execution)
          example: 100
        createdAt:
          type: string
          format: date-time
          description: Creation timestamp
        updatedAt:
          type: string
          format: date-time
          description: Last update timestamp

    # Base Response
    BaseResponse:
      type: object
      required:
        - code
        - message
        - timestamp
      properties:
        code:
          type: integer
          description: HTTP status code
          example: 200
        message:
          type: string
          description: Response message
          example: "Success"
        timestamp:
          type: string
          format: date-time
          description: Response timestamp (ISO 8601)
          example: "2026-02-11T10:30:00Z"

    ErrorResponse:
      allOf:
        - $ref: '#/components/schemas/BaseResponse'
        - type: object
          properties:
            error:
              type: object
              properties:
                code:
                  type: string
                  description: Error code
                  example: "INVALID_MESSAGE"
                details:
                  type: string
                  description: Detailed error message
                  example: "Message cannot be empty"
                field:
                  type: string
                  description: Field name (if validation error)
                  example: "message"

  responses:
    BadRequest:
      description: Invalid request parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            invalidMessage:
              value:
                code: 400
                message: "Bad Request"
                error:
                  code: "INVALID_PARAMETER"
                  details: "Message cannot be empty"
                  field: "message"
                timestamp: "2026-02-11T10:30:00Z"

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            ruleNotFound:
              value:
                code: 404
                message: "Not Found"
                error:
                  code: "RULE_NOT_FOUND"
                  details: "Statistics rule with ID 101 not found"
                timestamp: "2026-02-11T10:30:00Z"

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            serverError:
              value:
                code: 500
                message: "Internal Server Error"
                error:
                  code: "INTERNAL_ERROR"
                  details: "An unexpected error occurred"
                timestamp: "2026-02-11T10:30:00Z"

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token from /api/auth/login

security:
  - BearerAuth: []
