# Feature Specification: 聊天机器人路由系统

**Feature Branch**: `001-chatbot-router`
**Created**: 2026-02-06
**Status**: Draft
**Input**: User description: "聊天机器人：1. 接受不同聊天软件客户端上报的不同格式的聊天软件消息 2. 将消息路由到指定规则，由对应规则处理，生成指定格式的回复消息，并发送回聊天软件客户端。3. 后台管理系统。以前端页面的形式，支持配置化设置命中制定规则的消息处理逻辑，同时控制不同群聊的指定规则开关等功能。4. 支持不同聊天软件以不同消息格式和协进行消息上报5.支持配置化拓展不同客户端的消息格式及协议适配，首期先接入QQ客户端，具体为NapcatQQ客户端，websocket协议和http协议。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - QQ群消息自动回复 (Priority: P1)

管理员为QQ群配置自动回复规则,当群成员发送符合规则的消息时,机器人自动根据规则回复相应内容。

**Why this priority**: 这是机器人的核心功能,提供基础的消息接收、路由和回复能力。没有这个功能,系统无法提供任何实际价值。这是MVP的核心。

**Independent Test**: 可以通过配置一个简单的关键词匹配规则(如"你好"→"您好,有什么可以帮助您?"),在QQ群发送消息,验证机器人是否正确回复。

**Acceptance Scenarios**:

1. **Given** QQ群已连接到机器人系统且配置了关键词规则"帮助"→"请输入您的问题", **When** 群成员在群里发送"帮助", **Then** 机器人在3秒内回复"请输入您的问题"
2. **Given** 同一QQ群配置了多条规则(按优先级排序), **When** 群成员发送的消息匹配多条规则, **Then** 机器人使用优先级最高的规则生成回复
3. **Given** QQ群配置的规则已被管理员禁用, **When** 群成员发送符合该规则的消息, **Then** 机器人不做任何回复
4. **Given** 机器人收到NapcatQQ客户端通过WebSocket上报的群消息, **When** 消息内容符合已配置规则, **Then** 机器人通过WebSocket或HTTP协议发送回复消息到该群

---

### User Story 2 - 后台管理规则配置 (Priority: P2)

管理员通过Web管理后台创建、编辑和管理消息处理规则,控制不同群聊的规则启用状态。

**Why this priority**: 虽然规则配置是必需功能,但可以在P1完成后通过直接操作数据库临时实现,因此P2优先级合理。管理界面提升易用性和运营效率。

**Independent Test**: 管理员登录后台系统,创建一条新规则(如关键词匹配规则),为指定QQ群启用该规则,保存后在QQ群测试消息能触发该规则。

**Acceptance Scenarios**:

1. **Given** 管理员已登录后台系统, **When** 管理员创建一条新的消息处理规则并保存, **Then** 该规则立即生效,可在规则列表中查看和编辑
2. **Given** 管理员在规则列表页面, **When** 管理员为某个QQ群启用或禁用特定规则, **Then** 该群的消息处理立即应用新的规则配置
3. **Given** 管理员编辑现有规则, **When** 管理员修改规则的匹配条件或回复内容后保存, **Then** 所有使用该规则的群聊立即使用新的规则逻辑
4. **Given** 管理员在后台查看规则列表, **When** 页面加载, **Then** 显示所有规则及其使用状态(启用该规则的群聊数量)

---

### User Story 3 - 多客户端协议适配 (Priority: P3)

系统管理员通过配置添加对新聊天软件客户端的支持,定义该客户端的消息格式和通信协议。

**Why this priority**: 首期只接入NapcatQQ,多客户端扩展是未来需求。P3确保架构支持扩展性,但不阻塞MVP上线。

**Independent Test**: 管理员在后台系统配置一个新的客户端类型(如"微信客户端"),定义其消息格式映射规则,系统能够解析该客户端上报的消息并正确路由处理。

**Acceptance Scenarios**:

1. **Given** 系统支持配置化添加新客户端, **When** 管理员添加新客户端配置(包括消息格式定义、协议类型), **Then** 系统能够接收和解析该客户端的消息
2. **Given** 不同客户端使用不同的消息格式, **When** 系统收到来自不同客户端的消息, **Then** 系统根据客户端类型正确解析消息内容并路由到规则引擎
3. **Given** 客户端支持多种通信协议(如WebSocket、HTTP), **When** 管理员为客户端配置通信协议, **Then** 系统使用配置的协议与客户端通信

---

### Edge Cases

- **What happens when** 消息处理规则执行超时(如调用外部API响应慢)?
  - 系统应在5秒内超时,记录错误日志,不回复消息(避免延迟回复引起混乱)

- **What happens when** 同一消息匹配多条相同优先级的规则?
  - 使用创建时间最早的规则(规则ID最小)

- **What happens when** NapcatQQ客户端断开连接后重连?
  - 系统自动重新建立连接,重连期间的消息由客户端缓存(客户端责任),重连后继续处理新消息

- **What happens when** 管理员删除正在被使用的规则?
  - 系统应先检查规则是否被群聊使用,如果被使用则提示管理员先禁用该规则,防止误删

- **What happens when** 机器人回复消息发送失败(如被踢出群、网络错误)?
  - 记录发送失败日志,包含失败原因和群聊信息,不重试(避免刷屏),管理员可在后台查看失败记录

- **What happens when** 消息内容包含敏感词或违规内容?
  - 首期不实施自动内容审核功能,管理员在配置规则时需自行确保回复内容的合规性。系统不对消息内容进行敏感词检测或过滤。

- **What happens when** 同一用户在短时间内连续发送大量消息?
  - 系统应有频率限制(如同一用户5秒内最多触发3次规则),超过限制则忽略消息,防止被滥用

## Requirements *(mandatory)*

### Functional Requirements

**消息接收与路由**:

- **FR-001**: 系统必须支持通过WebSocket协议接收NapcatQQ客户端上报的QQ群消息
- **FR-002**: 系统必须支持通过HTTP协议接收NapcatQQ客户端上报的QQ群消息
- **FR-003**: 系统必须解析NapcatQQ消息格式,提取消息内容、发送者信息、群聊信息等关键字段
- **FR-004**: 系统必须将接收到的消息路由到规则引擎进行匹配处理
- **FR-005**: 系统必须按照规则优先级顺序匹配消息,找到第一条匹配的规则后停止继续匹配

**消息回复**:

- **FR-006**: 系统必须根据匹配的规则生成回复消息内容
- **FR-007**: 系统必须将回复消息转换为NapcatQQ客户端要求的消息格式
- **FR-008**: 系统必须通过WebSocket或HTTP协议发送回复消息到NapcatQQ客户端
- **FR-009**: 系统必须记录每次消息处理的日志,包括接收时间、匹配规则、回复内容、发送结果

**规则管理**:

- **FR-010**: 系统必须支持管理员创建消息处理规则,包括规则名称、匹配条件、回复内容、优先级
- **FR-011**: 系统必须支持至少以下规则类型:关键词匹配(完全匹配)、关键词包含(模糊匹配)、正则表达式匹配
- **FR-012**: 系统必须支持管理员编辑现有规则的所有属性
- **FR-013**: 系统必须支持管理员删除规则(删除前检查是否被使用)
- **FR-014**: 系统必须支持管理员为每个QQ群单独启用或禁用特定规则
- **FR-015**: 系统必须支持管理员查看规则列表,包括规则使用情况(启用该规则的群聊数量)

**后台管理系统**:

- **FR-016**: 系统必须提供Web管理界面供管理员登录和使用
- **FR-017**: 系统必须支持管理员通过用户名和密码登录后台系统
- **FR-018**: 管理员必须能够在后台查看所有已连接的QQ群列表
- **FR-019**: 管理员必须能够在后台为每个QQ群配置启用/禁用的规则列表
- **FR-020**: 管理员必须能够在后台查看消息处理日志,包括筛选功能(按群聊、时间范围、规则)

**客户端适配与扩展**:

- **FR-021**: 系统必须支持配置化添加新的聊天客户端类型(首期仅实现NapcatQQ,但架构需支持扩展)
- **FR-022**: 系统必须为每种客户端类型定义消息格式解析规则和协议适配器
- **FR-023**: 系统必须支持同一客户端类型使用多种通信协议(如WebSocket和HTTP)

**性能与可靠性**:

- **FR-024**: 系统必须在收到消息后3秒内完成规则匹配和回复发送
- **FR-025**: 系统必须支持对同一用户的消息频率限制(如5秒内最多处理3条消息)
- **FR-026**: 系统必须在WebSocket连接断开时自动尝试重连(最多重试3次,每次间隔5秒)

### Key Entities

- **聊天客户端 (Chat Client)**: 代表一个聊天软件客户端实例(如NapcatQQ),包含客户端ID、类型(QQ/微信等)、连接状态、协议类型(WebSocket/HTTP)、连接配置信息
- **群聊 (Group Chat)**: 代表一个聊天群组(如QQ群),包含群ID、群名称、所属客户端、已启用的规则列表、创建时间
- **消息处理规则 (Message Rule)**: 代表一条消息处理规则,包含规则ID、规则名称、规则类型(关键词匹配/正则表达式等)、匹配条件、回复模板、优先级、创建时间、更新时间
- **群聊规则配置 (Group Rule Config)**: 代表群聊与规则的关联关系,包含群ID、规则ID、是否启用、配置时间
- **消息记录 (Message Log)**: 代表一次消息处理记录,包含消息ID、群ID、发送者信息、消息内容、匹配的规则ID、回复内容、处理时间、发送状态(成功/失败)
- **管理员 (Admin User)**: 代表系统管理员,包含用户ID、用户名、密码(加密存储)、创建时间、最后登录时间

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: QQ群成员发送符合规则的消息后,机器人在3秒内完成回复(P95延迟 < 3秒)
  - **测量点**: 从系统通过WebSocket接收到NapCat消息事件开始,到通过HTTP API成功发送回复消息(HTTP 200响应)为止的总耗时
  - **测量方法**: 使用JMeter或Gatling模拟100并发用户,持续5分钟,记录每次消息处理的端到端延迟,计算P95值
- **SC-002**: 系统能够同时处理至少100个QQ群的消息,无消息丢失或延迟超过5秒
  - **消息可靠性语义**: 采用**at-most-once**交付保证(首期MVP)
    - WebSocket连接正常期间:接收到的消息尽力处理,处理失败记录错误日志但不重试
    - WebSocket断线期间:消息由NapCat客户端缓存,重连后仅处理新消息(断线期间消息不回溯)
    - 系统重启:内存中未完成的消息丢失,不实现持久化消息队列
  - **测试方法**: 在100个QQ群同时发送消息(每群10条/分钟),验证系统稳定运行5分钟,所有成功接收的消息均有日志记录
  - **未来扩展**: 后续版本可升级为at-least-once语义(引入消息队列和重试机制)
- **SC-003**: 管理员能够在5分钟内完成一条新规则的创建和群聊配置
- **SC-004**: 规则配置的修改能够在30秒内在所有相关群聊生效
- **SC-005**: 系统消息处理成功率达到99%(排除客户端断线等外部因素)
- **SC-006**: WebSocket连接断开后,系统能在15秒内(3次重试)自动重连成功
- **SC-007**: 管理员能够在后台查看最近7天的消息处理日志,筛选和查询响应时间 < 2秒
- **SC-008**: 系统支持配置化添加新客户端类型,无需修改核心代码(通过配置文件或管理界面完成)

### Assumptions

1. **NapcatQQ客户端稳定性**: 假设NapcatQQ客户端本身运行稳定,能够正常上报消息和接收回复。如果客户端频繁崩溃或断线,超出本系统控制范围
2. **消息格式标准化**: 假设NapcatQQ客户端遵循其官方文档定义的消息格式,不会出现格式突变
3. **网络环境**: 假设系统部署在稳定的网络环境中,与NapcatQQ客户端之间的网络延迟 < 100ms
4. **规则复杂度**: 首期规则类型限定为关键词匹配、关键词包含和正则表达式,不包含复杂的AI对话或外部API调用(如需要可在后续版本扩展)
5. **回复内容类型**: 首期仅支持纯文本回复,不支持图片、语音、视频等富媒体内容(可后续扩展)
6. **认证与权限**: 后台管理系统仅支持管理员账号登录,暂不区分不同管理员的权限级别(所有管理员权限相同)
7. **数据量级**: 假设初期接入的QQ群数量 < 1000个,每个群每天消息量 < 10000条,数据库和系统资源能够满足该量级
8. **内容审核**: 首期不包含自动内容审核功能,管理员需自行管理规则内容的合规性

### Out of Scope (本期不包含)

1. **多客户端实际接入**: 首期仅实现NapcatQQ客户端接入,其他客户端(微信、钉钉等)的实际适配工作不在本期范围
2. **私聊消息处理**: 首期仅支持QQ群消息,不支持私聊消息的自动回复
3. **富媒体消息**: 不支持图片、语音、视频等富媒体消息的接收和发送(仅纯文本)
4. **AI对话**: 不包含基于AI(如ChatGPT)的智能对话功能,仅支持规则匹配的固定回复
5. **统计报表**: 不包含详细的数据统计和可视化报表(如消息量趋势图、规则命中率分析)
6. **用户权限管理**: 不包含细粒度的用户权限管理(如只读管理员、超级管理员等角色)
7. **多语言支持**: 管理界面仅支持中文,不包含国际化和多语言切换
8. **消息队列**: 不使用消息队列进行消息处理(直接同步处理),高并发优化留待后续版本
